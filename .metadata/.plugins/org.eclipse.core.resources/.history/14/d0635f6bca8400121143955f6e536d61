package Network.ToClient;

import java.io.File;
import java.util.Map;

import Model.WordList;
import Network.TCPClient;
import Network.Protocols.ProtocolResultFM;
import Network.Protocols.ProtocolResultFS;

public class ResultSender {
	
	private boolean mIsConnected;
	private TCPClient mNetClient;
	
	public ResultSender() {
		mIsConnected = false;
		mNetClient = new TCPClient();
	}
	
	public boolean connect(String ip, int port) {
		if(!mIsConnected) {
			if(mNetClient == null || !mNetClient.connect(ip, port)) {
				return false;
			}
			mIsConnected = true;
		}
		return true;
	}
	
	public void disconnect() {
		if(mIsConnected && mNetClient != null) {
				mNetClient.disconnect();
				mIsConnected = false;
		}
	}
	
	
	
	public boolean sendResult(String filename, WordList list) {
		
		if(!mIsConnected
				|| list == null) {
			
			return false;
		}
		
		StringBuilder content = new StringBuilder();
	    for(Map.Entry<String, Integer> e : index.entrySet()) {
	    	content.append(e.getKey());
	    	content.append(ProtocolResultFM.WORD_COUNT_SEPARATOR);
	    	content.append(e.getValue());
	    	content.append(ProtocolResultFS.COMMON_END_LINE);
		}
		
		long fileSize = content.length();
		
		final StringBuilder query = new StringBuilder();
		
		query.append(ProtocolResultFM.MASTER_SEND_RESULT);
		query.append(ProtocolResultFM.COMMON_END_LINE);
		query.append(ProtocolResultFM.MASTER_FILE_NAME);
		query.append(ProtocolResultFM.COMMON_SEPARATOR);
		query.append(fileName);
		query.append(ProtocolResultFM.COMMON_END_LINE);
		query.append(ProtocolResultFM.MASTER_RESULT_SIZE);
		query.append(ProtocolResultFM.COMMON_SEPARATOR);
		query.append(String.valueOf(fileSize));
		query.append(ProtocolResultFM.COMMON_END_LINE);
		query.append(ProtocolResultFM.COMMON_END_LINE);
		
		final StringBuilder footer = new StringBuilder(ProtocolResultFM.COMMON_END_LINE);
		
		final String response = mNetClient.sendFile(query.toString(), fileToSend, footer.toString());
		
		if(ProtocolResultFM.CLIENT_OK.equals(response)) {
			return true;
		} else {
			return false;
		}
	}
}
