package Network.ToSlave;

import java.io.File;

import Network.TCPClient;
import Network.Protocol.ProtocolQuery;
import System.Utils;

public class PartSender {
	
	private boolean mIsConnected;
	private TCPClient mNetClient;
	private String mSlaveIp;
	private int mSlavePort;
	
	public PartSender(String slaveIp, int slavePort) {
		mIsConnected = false;
		mNetClient = new TCPClient();
		mSlaveIp = slaveIp;
		mSlavePort = slavePort;
	}
	
	public boolean checkAvailability() {
		if(!mIsConnected) {
			if(!mNetClient.connect(mSlaveIp, mSlavePort)) {
				return false;
			}
			mIsConnected = true;
		}
		
		final StringBuilder toSend = new StringBuilder();
		final String response;
		
		toSend.append(ProtocolPart.MASTER_CHECK_AVAILABILITY);
		toSend.append(ProtocolPart.COMMON_END_LINE);
		
		response = mNetClient.sendData(toSend.toString());
		
		if(ProtocolQuery.SLAVE_OK.equals(response)) {
			return true;
		} else {
			return false;
		}
	}
	
	public boolean sendFile(String filename, String filepath, String resultIP, int resultPort, int timeout) {
		
		if(!mIsConnected) {
			if(!mNetClient.connect(mSlaveIp, mSlavePort)) {
				return false;
			}
			mIsConnected = true;
		} else if(filename == null 
				|| filename.isEmpty()
				|| filepath == null
				|| filepath.isEmpty()
				|| !Utils.checkIP(resultIP)) {
			
			return false;
		}
		
		File fileToSend = new File(filepath);
		if(!fileToSend.exists()) {
			return false;
		}
		long fileSize = fileToSend.length();
		
		final StringBuilder query = new StringBuilder();
		
		query.append(ProtocolQuery.MASTER_SEND_PART);
		query.append(ProtocolQuery.COMMON_END_LINE);
		query.append(ProtocolQuery.MASTER_PART_NAME);
		query.append(ProtocolQuery.COMMON_SEPARATOR);
		query.append(filename);
		query.append(ProtocolQuery.COMMON_END_LINE);
		query.append(ProtocolQuery.MASTER_PART_SIZE);
		query.append(ProtocolQuery.COMMON_SEPARATOR);
		query.append(String.valueOf(fileSize));
		query.append(ProtocolQuery.COMMON_END_LINE);
		query.append(ProtocolQuery.MASTER_RESULT_IP);
		query.append(ProtocolQuery.COMMON_SEPARATOR);
		query.append(resultIP);
		query.append(ProtocolQuery.COMMON_END_LINE);
		query.append(ProtocolQuery.MASTER_RESULT_PORT);
		query.append(ProtocolQuery.COMMON_SEPARATOR);
		query.append(String.valueOf(resultPort));
		query.append(ProtocolQuery.COMMON_END_LINE);
		query.append(ProtocolQuery.MASTER_RESULT_PORT);
		query.append(ProtocolQuery.COMMON_SEPARATOR);
		query.append(String.valueOf(timeout));
		query.append(ProtocolQuery.COMMON_END_LINE);
		query.append(ProtocolQuery.COMMON_END_LINE);
		
		final StringBuilder footer = new StringBuilder(ProtocolQuery.COMMON_END_LINE);
		
		final String response = mNetClient.sendFile(query.toString(), fileToSend, footer.toString());
		
		mNetClient.disconnect();
		mIsConnected = false;
		
		if(ProtocolQuery.SLAVE_OK.equals(response)) {
			return true;
		} else {
			return false;
		}
	}
}
